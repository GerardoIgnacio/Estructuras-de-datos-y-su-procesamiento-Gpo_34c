# üíª Proyecto: Sistema de Ventas en Python

Este es un sistema simple de punto de venta (POS) creado en Python y SQLite. El programa est√° dise√±ado para ejecutarse en la terminal y permite gestionar clientes y registrar ventas de ropa, aplicando un descuento especial a nuevos clientes.

## üöÄ Funcionalidades Principales

* **Registro de Clientes:** Guarda nuevos clientes (nombre y email) en una base de datos SQLite.
* **Registro de Ventas:** Permite al operador ingresar una descripci√≥n de la venta (ej. "Camisa") y un monto total.
* **Descuento por Primera Compra:** Aplica autom√°ticamente un **descuento del 45%** si es la primera compra de un cliente.
* **Reportes en Terminal:** Muestra un historial de todas las ventas y una lista de los clientes registrados.
* **Exportaci√≥n a Excel:** Genera un archivo `.xlsx` (`Reporte_Ventas.xlsx`) con un desglose completo de todas las transacciones para un f√°cil an√°lisis.

## üõ†Ô∏è Tecnolog√≠as Usadas

* **Python 3**
* **SQLite3** (para la base de datos local)
* **Openpyxl** (para la exportaci√≥n a Excel)[PIAEYCDVENTAS.py](https://github.com/user-attachments/files/23381568/PIAEYCDVENTAS.py)
#
# --- PROGRAMA COMPLETO (SIN INVENTARIO / SIN ITEMS) ---
#
import sqlite3
import sys
from datetime import datetime
from sqlite3 import Error
import openpyxl  # Aseg√∫rate de tenerlo: pip install openpyxl

#
# --- SECCI√ìN 1: (Contenido de clases.py) ---
#
class BD:
    """
    Clase para gestionar la conexi√≥n y operaciones 
    con la base de datos SQLite.
    """
    
    def __init__(self, db_nombre):
        """Inicializa con el nombre del archivo de la DB."""
        self.db_nombre = db_nombre
        self.conn = None

    def _conectar(self, detect_types=False):
        """Funci√≥n interna para conectar a la DB."""
        try:
            if detect_types:
                self.conn = sqlite3.connect(self.db_nombre, 
                                            detect_types=sqlite3.PARSE_DECLTYPES | sqlite3.PARSE_COLNAMES)
            else:
                self.conn = sqlite3.connect(self.db_nombre)
        except Error as e:
            print(f"Error al conectar a la DB: {e}")
            return None
        return self.conn

    def _desconectar(self):
        """Funci√≥n interna para cerrar la conexi√≥n."""
        if self.conn:
            self.conn.close()
            self.conn = None

    def iniciar_tablas(self):
        """Crea las tablas 'Clientes' y 'Ventas'."""
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                
                # --- Tabla de Clientes ---
                mi_cursor.execute("""
                    CREATE TABLE IF NOT EXISTS Clientes (
                        cliente_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        nombre TEXT NOT NULL,
                        email TEXT NOT NULL UNIQUE,
                        fecha_registro TIMESTAMP
                    );
                """)
                
                # --- MODIFICADA: Tabla de Ventas ---
                # Agregamos 'descripcion' para guardar "Camisa", "Pantal√≥n", etc.
                mi_cursor.execute("""
                    CREATE TABLE IF NOT EXISTS Ventas (
                        venta_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        cliente_id INTEGER NOT NULL,
                        descripcion TEXT NOT NULL, -- <-- Columna para "Camisa", etc.
                        monto_total REAL NOT NULL,
                        monto_descuento REAL NOT NULL,
                        monto_final REAL NOT NULL,
                        fecha_venta TIMESTAMP,
                        FOREIGN KEY (cliente_id) REFERENCES Clientes (cliente_id)
                    );
                """)
                
                conn.commit()
                print("Tablas 'Clientes' y 'Ventas' verificadas/creadas exitosamente.")
                
        except Error as e:
            print(f"Error al crear tablas: {e}")
        finally:
            self._desconectar()

    # --- M√©todos para Clientes (Sin cambios) ---
    
    def buscar_cliente_por_email(self, email):
        resultado = None
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute("SELECT cliente_id FROM Clientes WHERE email = ?", (email,))
                fila = mi_cursor.fetchone()
                if fila:
                    resultado = fila[0]
        except Error as e:
            print(f"Error al buscar cliente: {e}")
        finally:
            self._desconectar()
        return resultado

    def insertar_cliente(self, nombre, email, fecha_registro):
        nuevo_id = None
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute(
                    "INSERT INTO Clientes (nombre, email, fecha_registro) VALUES (?, ?, ?)",
                    (nombre, email, fecha_registro)
                )
                conn.commit()
                nuevo_id = mi_cursor.lastrowid
        except Error as e:
            print(f"Error al insertar cliente: {e}")
        finally:
            self._desconectar()
        return nuevo_id

    def obtener_clientes(self):
        registros = []
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute("SELECT cliente_id, nombre, email, fecha_registro FROM Clientes")
                registros = mi_cursor.fetchall()
        except Error as e:
            print(f"Error al obtener clientes: {e}")
        finally:
            self._desconectar()
        return registros

    # --- M√©todos para Ventas (Modificados) ---

    def contar_ventas_cliente(self, cliente_id):
        conteo = 0
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute("SELECT COUNT(*) FROM Ventas WHERE cliente_id = ?", (cliente_id,))
                conteo = mi_cursor.fetchone()[0]
        except Error as e:
            print(f"Error al contar ventas: {e}")
        finally:
            self._desconectar()
        return conteo

    # Acepta 'descripcion'
    def insertar_venta(self, cliente_id, descripcion, total, descuento, final, fecha_venta):
        """Registra una nueva venta en la DB."""
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                # Se a√±ade 'descripcion' a los valores
                valores = (cliente_id, descripcion, total, descuento, final, fecha_venta)
                mi_cursor.execute(
                    "INSERT INTO Ventas (cliente_id, descripcion, monto_total, monto_descuento, monto_final, fecha_venta) VALUES (?, ?, ?, ?, ?, ?)",
                    valores
                )
                conn.commit()
                print("¬°Venta registrada exitosamente en la DB!")
        except Error as e:
            print(f"Error al insertar venta: {e}")
        finally:
            self._desconectar()

    # Se a√±ade 'descripcion' a la consulta
    def obtener_ventas_con_cliente(self):
        """Obtiene historial de ventas con JOIN a Clientes."""
        registros = []
        try:
            conn = self._conectar()
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute("""
                    SELECT V.venta_id, C.nombre, V.descripcion, V.monto_total, 
                           V.monto_descuento, V.monto_final, V.fecha_venta
                    FROM Ventas V
                    INNER JOIN Clientes C ON V.cliente_id = C.cliente_id
                    ORDER BY V.fecha_venta DESC
                """)
                registros = mi_cursor.fetchall()
        except Error as e:
            print(f"Error al obtener ventas: {e}")
        finally:
            self._desconectar()
        return registros
        
    # Se a√±ade 'descripcion' a la consulta de Excel
    def obtener_ventas_para_excel(self):
        """Obtiene los datos espec√≠ficos para el reporte de Excel."""
        registros = []
        try:
            conn = self._conectar(detect_types=True) 
            if conn:
                mi_cursor = conn.cursor()
                mi_cursor.execute("""
                    SELECT 
                        V.venta_id, 
                        C.nombre, 
                        V.fecha_venta, 
                        V.descripcion,      -- <-- Columna para "Camisa"
                        V.monto_total,  
                        V.monto_descuento, 
                        V.monto_final
                    FROM Ventas V
                    INNER JOIN Clientes C ON V.cliente_id = C.cliente_id
                    ORDER BY V.fecha_venta ASC
                """)
                registros = mi_cursor.fetchall()
        except Error as e:
            print(f"Error al obtener datos para Excel: {e}")
        finally:
            self._desconectar()
        return registros

#
# --- SECCI√ìN 2: (Contenido de funciones.py) ---
#

class Ventas:
    """
    Clase para gestionar la l√≥gica de la aplicaci√≥n de ventas
    (men√∫s, entradas de usuario, c√°lculos).
    """
    
    def __init__(self, bd_manager):
        if not isinstance(bd_manager, BD):
            raise TypeError("Se esperaba una instancia de la clase BD")
        self.bd = bd_manager

    # --- FUNCI√ìN registrar_venta (MODO MANUAL) ---
    def registrar_venta(self):
        """
        L√≥gica para registrar una nueva venta, pidiendo datos
        manualmente al usuario.
        """
        print("\n--- Registrar Nueva Venta ---")
        try:
            # --- 1. Identificar al Cliente (Igual que antes) ---
            email_cliente = input("Email del cliente (o 'SALIR'): ").strip()
            if email_cliente.upper() == 'SALIR':
                return
            if not email_cliente:
                print("El email no puede estar vac√≠o.")
                return

            cliente_id = None
            es_primera_compra = False
            cliente_id = self.bd.buscar_cliente_por_email(email_cliente)

            if cliente_id:
                num_ventas = self.bd.contar_ventas_cliente(cliente_id)
                if num_ventas == 0:
                    es_primera_compra = True
                    print(f"Cliente existente (ID: {cliente_id}). ¬°Es su primera compra! üéÅ")
                else:
                    es_primera_compra = False
                    print(f"Cliente existente (ID: {cliente_id}) con {num_ventas} compras previas.")
            else:
                print("Cliente nuevo detectado.")
                nombre_cliente = input("Nombre del nuevo cliente: ").strip()
                if not nombre_cliente:
                    print("El nombre no puede estar vac√≠o. Operaci√≥n cancelada.")
                    return
                
                fecha_actual = datetime.now()
                cliente_id = self.bd.insertar_cliente(nombre_cliente, email_cliente, fecha_actual)
                if cliente_id:
                    print(f"Cliente '{nombre_cliente}' registrado con ID: {cliente_id}.")
                    es_primera_compra = True
                else:
                    print("Error: No se pudo registrar al nuevo cliente.")
                    return

            # --- 2. Solicitar Datos de la Venta (MANUAL) ---
            
            descripcion_venta = input("Descripci√≥n de la venta (Ej. Camisa, Pantal√≥n): ").strip()
            if not descripcion_venta:
                print("La descripci√≥n no puede estar vac√≠a. Venta cancelada.")
                return

            try:
                monto_total = float(input("Monto total de la venta: $"))
                if monto_total <= 0:
                    print("El monto debe ser positivo.")
                    return
            except ValueError:
                print("Monto no v√°lido. Venta cancelada.")
                return

            # --- 3. Calcular Descuento (Igual que antes) ---
            monto_descuento = 0.0
            monto_final = monto_total

            print("\n--- Resumen de Compra ---")
            
            if es_primera_compra:
                monto_descuento = monto_total * 0.45 # ¬°Aplica descuento!
                monto_final = monto_total - monto_descuento
                print(f"Monto Original: ${monto_total:,.2f}")
                print("¬°DESCUENTO APLICADO! (45%)")
                print(f"Descuento:      ${monto_descuento:,.2f}")
                print(f"Monto Final:    ${monto_final:,.2f}")
            else:
                print(f"Monto Final (sin descuento): ${monto_final:,.2f}")

            # --- 4. Insertar la Venta (Modificado) ---
            fecha_venta = datetime.now()
            # Pasamos la 'descripcion_venta'
            self.bd.insertar_venta(cliente_id, descripcion_venta, monto_total, monto_descuento, monto_final, fecha_venta)

        except Exception as e:
            print(f"Se produjo un error inesperado (Registrar_Venta): {e}")

    def ver_clientes(self):
        """Muestra todos los clientes registrados."""
        print("\n--- Listado de Clientes ---")
        registros = self.bd.obtener_clientes()
        
        if registros:
            print("ID\tNombre\t\tEmail\t\t\tFecha Registro")
            print("-" * 60)
            for id_c, nombre, email, fecha in registros:
                print(f"{id_c}\t{nombre:<15}\t{email:<25}\t{fecha}")
        else:
            print("No hay clientes registrados.")

    # Modificado para mostrar 'descripcion'
    def ver_ventas(self):
        """Muestra todas las ventas registradas."""
        print("\n--- Historial de Ventas ---")
        registros = self.bd.obtener_ventas_con_cliente()
        
        if registros:
            print("ID Venta\tCliente\t\tDescripci√≥n\tMonto Total\tDescuento\tMonto Final\tFecha Venta")
            print("-" * 110)
            # Se a√±ade 'desc' (descripcion)
            for id_v, nombre, desc, total, desc_amt, final, fecha in registros:
                print(f"{id_v}\t\t{nombre:<15}\t{desc:<10}\t${total:<10.2f}\t${desc_amt:<10.2f}\t${final:<10.2f}\t{fecha}")
        else:
            print("No hay ventas registradas.")

    # Modificado para exportar 'descripcion'
    def exportar_excel(self):
        """Exporta el reporte de ventas a Excel."""
        print("\n--- Exportando Ventas a Excel ---")
        
        try:
            registros = self.bd.obtener_ventas_para_excel()

            if not registros:
                print("No hay ventas para exportar.")
                return

            workbook = openpyxl.Workbook()
            hoja = workbook.active
            hoja.title = "Reporte de Ventas"

            # Se a√±ade 'Descripci√≥n'
            headers = ["ID de Venta", "Cliente", "Fecha y Hora", "Descripci√≥n", "Monto Original", "Descuento Aplicado", "Total de la Venta"]
            hoja.append(headers)

            for row in registros:
                hoja.append(row)
            
            # Se re-indexan las columnas para el formato
            for row_num in range(2, hoja.max_row + 1):
                # Col 3: Fecha
                cell_fecha = hoja.cell(row=row_num, column=3)
                cell_fecha.number_format = 'DD/MM/YYYY HH:MM:SS'
                
                # Col 4: Descripci√≥n (es texto, sin formato)
                
                # Col 5: Monto Original
                cell_original = hoja.cell(row=row_num, column=5) 
                cell_original.number_format = '"$"#,##0.00'
                
                # Col 6: Descuento
                cell_descuento = hoja.cell(row=row_num, column=6)
                cell_descuento.number_format = '"$"#,##0.00'
                
                # Col 7: Total
                cell_total = hoja.cell(row=row_num, column=7)
                cell_total.number_format = '"$"#,##0.00'

            # Auto-ajustar ancho
            for col in hoja.columns:
                max_length = 0
                column_letter = col[0].column_letter
                for cell in col:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                hoja.column_dimensions[column_letter].width = adjusted_width

            filename = "Reporte_Ventas.xlsx"
            workbook.save(filename)
            print(f"Reporte guardado exitosamente como '{filename}'")

        except Exception as e:
            print(f"Se produjo un error inesperado (Exportar_VL): {e}")
            print("Aseg√∫rate de tener instalada la librer√≠a 'openpyxl' (pip install openpyxl)")

    def menu(self):
        """Muestra el men√∫ principal y maneja la selecci√≥n del usuario."""
        while True:
            print("\n---- MEN√ö DE VENTAS ----")
            print("1. Registrar Venta (Se aplicara descuento de 45% en su primera compra)")
            print("2. Ver Clientes Registrados")
            print("3. Ver Historial de Ventas")
            print("4. Exportar Reporte de Ventas a Excel")
            print("5. Salir del programa")
            
            try:
                opcion = int(input("Selecciona una opci√≥n (1-5): "))
                
                if opcion == 1:
                    self.registrar_venta()
                elif opcion == 2:
                    self.ver_clientes()
                elif opcion == 3:
                    self.ver_ventas()
                elif opcion == 4:
                    self.exportar_excel()
                elif opcion == 5:
                    print("Saliendo del programa...")
                    sys.exit()
                else:
                    print("Opci√≥n no v√°lida. Por favor, selecciona un n√∫mero entre 1 y 5.")
                    
            except ValueError:
                print("Entrada no v√°lida. Por favor, ingresa un n√∫mero.")


#(Contenido de menu---
#

if __name__ == "__main__":
    
    # 1. Crea el objeto que maneja la base de datos
    bd_ventas = BD("ventas.db")
    
    # 2. Se asegura de que las tablas est√©n creadas
    bd_ventas.iniciar_tablas()
    
    # 3. Crea el objeto que maneja la l√≥gica de la aplicaci√≥n
    programa_ventas = Ventas(bd_ventas)
    
    # 4. Inicia el men√∫ principal
    programa_ventas.menu()
